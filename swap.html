<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozyswap - Plasma Swap DEX | Swap, Liquidity, and Earn COZY</title>
  <meta name="description" content="Cozyswap is a decentralized exchange (DEX) built on Plasma Chain. Swap tokens instantly, add liquidity, and earn rewards in COZY Token." />
  
  <style>
    :root{--bg:#0b0b0f;--card:#111216;--muted:#9aa0a6;--accent1:#6c63ff;--accent2:#00c6ff}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:#e6eef8;font-family:Inter,system-ui,Arial}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
    .app{width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:50%;object-fit:cover}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .container{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px}
    .row{display:flex;gap:10px}
    input[type=text], input[type=number], select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eef8;padding:10px;border-radius:10px;width:100%}
    .amount{font-size:20px;color:#fff;padding:6px 0}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .status{font-size:13px;color:var(--muted);margin-left:8px}
    .green{color:#6ee7b7}.yellow{color:#fbbf24}.red{color:#fb7185}
    @media(min-width:900px){.container{grid-template-columns:480px 1fr}}
    .maxbtn{background:transparent;border:1px dashed rgba(255,255,255,0.08);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .smallbtn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .txhash{word-break:break-all;color:var(--muted);margin-top:8px}

    .token-select-container{position:relative;width:100%}
    .selected-token{display:flex;align-items:center;padding:8px 12px;border:1px solid rgba(255,255,255,0.06);border-radius:10px;cursor:pointer;background:transparent;transition:all 0.2s;min-height:40px}
    .selected-token:hover{border-color:rgba(255,255,255,0.1);background:rgba(255,255,255,0.02)}
    .token-logo-sm{width:20px;height:20px;border-radius:50%;margin-right:8px;object-fit:cover}
    .token-dropdown{position:absolute;top:100%;left:0;right:0;background:#111216;border:1px solid rgba(255,255,255,0.06);border-radius:12px;max-height:300px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);margin-top:5px}
    .token-option{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s ease}
    .token-option:last-child{border-bottom:none}
    .token-option:hover{background:rgba(255,255,255,0.05)}
    .token-info{display:flex;flex-direction:column;gap:2px;flex:1;margin-left:8px}
    .token-symbol{font-weight:500;font-size:14px}
    .token-name{font-size:11px;color:#9aa0a6}
    .copy-btn{background:none;border:none;color:#aaa;font-size:16px;cursor:pointer;transition:color 0.2s ease,transform 0.1s ease;margin-left:auto}
    .copy-btn:hover{color:#fff;transform:scale(1.1)}
    .dropdown-arrow{margin-left:auto;font-size:10px;color:#9aa0a6}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 18px;background:rgba(40,167,69,0.9);color:#fff;font-size:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:9999;opacity:0;transition:opacity 0.3s ease}
    .toast.error{background:rgba(220,53,69,0.9)}
    .spinner{border:2px solid #f3f3f3;border-top:2px solid #6c63ff;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .active-btn{background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-weight:600;cursor:pointer;transition:all 0.2s ease-in-out;box-shadow:0 0 10px rgba(139,92,246,0.5)}
    .active-btn:hover{transform:scale(1.03);box-shadow:0 0 16px rgba(59,130,246,0.8)}
    .unwrap-btn{background:#f59e0b;color:#fff;border:none;border-radius:10px;padding:12px 24px;font-weight:600;cursor:pointer;transition:all 0.2s ease-in-out;box-shadow:0 0 10px rgba(245,158,11,0.5)}
    .unwrap-btn:hover{transform:scale(1.03);box-shadow:0 0 16px rgba(245,158,11,0.8)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <header>
        <div class="brand">
          <img class="logo" src="https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png" alt="Cozy" />
          <div>
            <h1 style="margin:0">CozySwap</h1>
            <div class="small">Plasma Chain (9745)</div>
          </div>
        </div>
        <div class="actions">
          <div class="small">@CozySwap</div>
          <button id="connectBtn" class="btn">Connect Wallet</button>
          <span id="status" class="status">Not connected</span>
        </div>
      </header>

      <div class="container">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Swap</strong><div class="small">Token to token</div></div>
            <div style="text-align:right">
              <button id="toLiquidity" class="active-btn">Add Liquidity</button> 
              <button id="toStaking" class="active-btn">Staking</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>From</label>
            <div class="row">
              <div style="flex:1">
                <input id="fromAmount" type="text" placeholder="0.0" />
                <div class="muted amount" id="fromReadable">—</div>
                <div class="small">Balance: <span id="fromBalance">—</span> <button id="maxFrom" class="maxbtn">Max</button></div>
              </div>
              <div style="width:220px;display:flex;gap:8px">
                <div class="token-select-container">
                  <div class="selected-token" onclick="toggleDropdown('from')">
                    <img id="selectedFromLogo" src="" class="token-logo-sm">
                    <span id="selectedFromSymbol">XPL</span>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div id="fromDropdown" class="token-dropdown"></div>
                </div>
                <button id="addTokenBtn" class="smallbtn" title="Add custom token">＋</button>
              </div>
            </div>

            <div style="height:8px"></div>
            <div style="text-align:center"><button id="flip" class="ghost">⇅</button></div>

            <div style="height:8px"></div>
            <label>To</label>
            <div class="row">
              <div style="flex:1">
                <div class="muted amount" id="toReadable">—</div>
                <div class="small">Balance: <span id="toBalance">—</span></div>
              </div>
              <div style="width:220px">
                <div class="token-select-container">
                  <div class="selected-token" onclick="toggleDropdown('to')">
                    <img id="selectedToLogo" src="" class="token-logo-sm">
                    <span id="selectedToSymbol">COZY</span>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div id="toDropdown" class="token-dropdown"></div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <div style="flex:1">
                <label>Slippage tolerance (%)</label>
                <input id="slippage" type="text" value="0.5" />
              </div>
              <div style="width:160px">
                <label>Deadline (min)</label>
                <input id="deadline" type="number" value="10" />
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="muted small" id="priceImpact">Price impact: —</div>
              <div class="muted small" id="liquidityInfo">Pool: —</div>
            </div>

            <div style="margin-top:14px">
              <button id="approveOrSwap" class="btn" disabled>Connect Wallet to Swap</button>
              <div id="txHash" class="txhash"></div>
            </div>

            <div class="footer">
              <div class="small">Estimated output updates live</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div><strong>About</strong><div class="small">CozySwap — Decentralized Exchange<br>Powered by Plasma • @CozySwap</div></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Wagmi dan Web3Modal
    import { createWeb3Modal, defaultWagmiConfig } from 'https://esm.sh/@web3modal/wagmi@2.6.2?bundle';
    import { getAccount, getWalletClient, getBalance, watchAccount, readContract, writeContract, waitForTransaction } from 'https://esm.sh/@wagmi/core@2.11.2?bundle';
    import { mainnet } from 'https://esm.sh/@wagmi/core@2.11.2/chains?bundle';

    // Plasma Chain Configuration
    const plasmaChain = {
      id: 9745,
      name: "Plasma Mainnet",
      network: "plasma-mainnet",
      nativeCurrency: { name: "XPL", symbol: "XPL", decimals: 18 },
      rpcUrls: {
        default: { http: ["https://plasma-mainnet.g.alchemy.com/v2/MuLXFm60Tsz3ntyrSC1O4"] }
      },
      blockExplorers: {
        default: { name: "PlasmaScan", url: "https://plasmascan.to" }
      }
    };

    // Contract Addresses
    const ROUTER = "0x9c6C47d2A87c6c7f8eBf5c6eD3c6a8a9f4c6d7e8";
    const FACTORY = "0x8f5d1c3c7e5a2a4b6c8d9e0f1a2b3c4d5e6f7a8b";
    const WXPL = "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2";

    // Contract ABIs
    const ERC20_ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint)",
      "function transfer(address to, uint amount) returns (bool)",
      "function approve(address spender, uint amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint)",
      "function deposit() payable",
      "function withdraw(uint wad)"
    ];

    const ROUTER_ABI = [
      "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)",
      "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)",
      "function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)",
      "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)"
    ];

    const FACTORY_ABI = [
      "function getPair(address tokenA, address tokenB) external view returns (address pair)"
    ];

    const PAIR_ABI = [
      "function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
      "function token0() external view returns (address)",
      "function token1() external view returns (address)"
    ];

    // WalletConnect Configuration
    const projectId = "a9ca60975a434a874c01a34c5f7ff722";
    const metadata = {
      name: "CozySwap",
      description: "Plasma DEX",
      url: "https://cozyswap.net/",
      icons: ["https://cozyswap.net/assets/cozy.png"]
    };

    const chains = [plasmaChain, mainnet];
    const wagmiConfig = defaultWagmiConfig({
      chains,
      projectId,
      metadata
    });

    // Create Web3Modal
    const modal = createWeb3Modal({
      wagmiConfig,
      projectId,
      chains,
      enableAnalytics: false
    });

    // Global State
    let tokens = [];
    let selectedFromToken = null;
    let selectedToToken = null;
    let isSwapping = false;

    // Default tokens
    const DEFAULTS = [
      { symbol: 'XPL', address: 'XPL_NATIVE', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/xpl.png' },
      { symbol: 'COZY', address: '0x06e2ef46662834f4e42dbf9ff9222b077c57df5c', logoURI: 'https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png' },
      { symbol: 'WXPL', address: WXPL, logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/xpl.png' },
      { symbol: 'WETH', address: '0x9895D81bB462A195b4922ED7De0e3ACD007c32CB', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/weth.png' },
      { symbol: 'USDT0', address: '0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/USDT0.png' }
    ];

    // Token management
    const TOKENS_KEY = 'cozy_tokens_v2';
    
    function loadTokens() {
      try {
        const raw = localStorage.getItem(TOKENS_KEY);
        if (raw) return JSON.parse(raw);
      } catch (e) {}
      return [...DEFAULTS];
    }

    function saveTokens(list) {
      localStorage.setItem(TOKENS_KEY, JSON.stringify(list));
    }

    // UI Functions
    function showToast(message, isError = false) {
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.className = isError ? "toast error" : "toast";
      document.body.appendChild(toast);

      setTimeout(() => toast.style.opacity = "1", 10);
      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 400);
      }, 2500);
    }

    function getDefaultLogo(symbol) {
      const defaultLogos = {
        'XPL': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzZjNjNmZiIvPjwvc3ZnPg==',
        'WXPL': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzAwYzZmZiIvPjwvc3ZnPg==',
        'COZY': 'https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png'
      };
      return defaultLogos[symbol] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzlmOWY5ZiIvPjwvc3ZnPg==';
    }

    function toggleDropdown(type) {
      const dropdown = document.getElementById(`${type}Dropdown`);
      const allDropdowns = document.querySelectorAll('.token-dropdown');

      allDropdowns.forEach(dd => {
        if (dd.id !== `${type}Dropdown`) dd.style.display = 'none';
      });

      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function copyAddress(addr) {
      if (!addr || addr === 'XPL_NATIVE') return showToast("⚠️ Token address not found", true);
      navigator.clipboard.writeText(addr)
        .then(() => showToast("✅ Token address copied to clipboard"))
        .catch(() => showToast("❌ Failed to copy address", true));
    }

    // Token Selection
    function refreshSelectors() {
      const fromDropdown = document.getElementById('fromDropdown');
      const toDropdown = document.getElementById('toDropdown');

      fromDropdown.innerHTML = '';
      toDropdown.innerHTML = '';

      tokens.forEach(token => {
        const createOption = (type) => {
          const option = document.createElement('div');
          option.className = 'token-option';
          option.innerHTML = `
            <img src="${token.logoURI || getDefaultLogo(token.symbol)}" 
                 alt="${token.symbol}" 
                 class="token-logo-sm"
                 onerror="this.src='${getDefaultLogo(token.symbol)}'">
            <div class="token-info">
              <span class="token-symbol">${token.symbol}</span>
              <span class="token-name">${token.name || token.symbol} Token</span>
            </div>
            <button class="copy-btn" title="Copy token address" onclick="event.stopPropagation(); copyAddress('${token.address}')">📋</button>
          `;
          option.onclick = (e) => {
            if (!e.target.classList.contains("copy-btn")) {
              selectToken(type, token);
            }
          };
          return option;
        };

        fromDropdown.appendChild(createOption('from'));
        toDropdown.appendChild(createOption('to'));
      });

      if (!selectedFromToken) selectToken('from', tokens[0]);
      if (!selectedToToken) selectToken('to', tokens[1]);
    }

    function selectToken(type, token) {
      const logoEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Logo`);
      const symbolEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Symbol`);
      const dropdownEl = document.getElementById(`${type}Dropdown`);

      logoEl.src = token.logoURI || getDefaultLogo(token.symbol);
      logoEl.onerror = () => { this.src = getDefaultLogo(token.symbol); };
      symbolEl.textContent = token.symbol;
      dropdownEl.style.display = 'none';

      if (type === 'from') {
        selectedFromToken = token;
      } else {
        selectedToToken = token;
      }

      updateSwapButton();
      updateBalances();
      computeOutput();
    }

    // Wallet Connection
    async function updateWalletUI() {
      const account = getAccount(wagmiConfig);
      const connectBtn = document.getElementById('connectBtn');
      const statusEl = document.getElementById('status');
      const swapBtn = document.getElementById('approveOrSwap');

      if (account?.address) {
        const shortAddr = `${account.address.slice(0, 6)}...${account.address.slice(-4)}`;
        connectBtn.textContent = shortAddr;
        
        try {
          const balance = await getBalance(wagmiConfig, { address: account.address });
          statusEl.textContent = `${parseFloat(balance.formatted).toFixed(4)} XPL`;
        } catch {
          statusEl.textContent = "Connected";
        }

        swapBtn.disabled = false;
        swapBtn.textContent = "Swap";
        
        await updateBalances();
      } else {
        connectBtn.textContent = "Connect Wallet";
        statusEl.textContent = "Not connected";
        swapBtn.disabled = true;
        swapBtn.textContent = "Connect Wallet to Swap";
        
        document.getElementById('fromBalance').textContent = "—";
        document.getElementById('toBalance').textContent = "—";
      }
    }

    // Balance Management
    async function updateBalances() {
      const account = getAccount(wagmiConfig);
      if (!account?.address) return;

      try {
        // From balance
        if (selectedFromToken.address === 'XPL_NATIVE') {
          const balance = await getBalance(wagmiConfig, { address: account.address });
          document.getElementById('fromBalance').textContent = parseFloat(balance.formatted).toFixed(6);
        } else {
          const balance = await readContract(wagmiConfig, {
            address: selectedFromToken.address,
            abi: ERC20_ABI,
            functionName: 'balanceOf',
            args: [account.address]
          });
          const decimals = await readContract(wagmiConfig, {
            address: selectedFromToken.address,
            abi: ERC20_ABI,
            functionName: 'decimals'
          });
          document.getElementById('fromBalance').textContent = parseFloat(balance / 10n ** BigInt(decimals)).toFixed(6);
        }

        // To balance
        if (selectedToToken.address === 'XPL_NATIVE') {
          const balance = await getBalance(wagmiConfig, { address: account.address });
          document.getElementById('toBalance').textContent = parseFloat(balance.formatted).toFixed(6);
        } else {
          const balance = await readContract(wagmiConfig, {
            address: selectedToToken.address,
            abi: ERC20_ABI,
            functionName: 'balanceOf',
            args: [account.address]
          });
          const decimals = await readContract(wagmiConfig, {
            address: selectedToToken.address,
            abi: ERC20_ABI,
            functionName: 'decimals'
          });
          document.getElementById('toBalance').textContent = parseFloat(balance / 10n ** BigInt(decimals)).toFixed(6);
        }
      } catch (error) {
        console.error('Error updating balances:', error);
      }
    }

    // Swap Logic
    function updateSwapButton() {
      const swapBtn = document.getElementById('approveOrSwap');
      if (!selectedFromToken || !selectedToToken) return;

      const from = selectedFromToken.address;
      const to = selectedToToken.address;
      const isXPLPair = (from === 'XPL_NATIVE' && to === WXPL) || (from === WXPL && to === 'XPL_NATIVE');

      if (isXPLPair) {
        swapBtn.textContent = from === 'XPL_NATIVE' ? 'Wrap' : 'Unwrap';
        swapBtn.className = 'unwrap-btn';
      } else {
        swapBtn.textContent = 'Swap';
        swapBtn.className = 'btn';
      }
    }

    async function computeOutput() {
      const amountInput = document.getElementById('fromAmount').value;
      if (!amountInput || !selectedFromToken || !selectedToToken) {
        document.getElementById('toReadable').textContent = "—";
        return;
      }

      try {
        const account = getAccount(wagmiConfig);
        if (!account?.address) return;

        const from = selectedFromToken.address === 'XPL_NATIVE' ? WXPL : selectedFromToken.address;
        const to = selectedToToken.address === 'XPL_NATIVE' ? WXPL : selectedToToken.address;
        
        const fromDecimals = selectedFromToken.address === 'XPL_NATIVE' ? 18 : await readContract(wagmiConfig, {
          address: selectedFromToken.address,
          abi: ERC20_ABI,
          functionName: 'decimals'
        });

        const amountIn = BigInt(Math.floor(parseFloat(amountInput) * 10 ** fromDecimals));
        const path = [from, to];

        const amounts = await readContract(wagmiConfig, {
          address: ROUTER,
          abi: ROUTER_ABI,
          functionName: 'getAmountsOut',
          args: [amountIn, path]
        });

        const toDecimals = selectedToToken.address === 'XPL_NATIVE' ? 18 : await readContract(wagmiConfig, {
          address: selectedToToken.address,
          abi: ERC20_ABI,
          functionName: 'decimals'
        });

        const amountOut = amounts[1] / 10n ** BigInt(toDecimals);
        document.getElementById('toReadable').textContent = amountOut.toString();
      } catch (error) {
        document.getElementById('toReadable').textContent = "—";
        console.error('Error computing output:', error);
      }
    }

    // Execute Swap/Unwrap
    async function executeSwap() {
      if (isSwapping) return;
      
      const account = getAccount(wagmiConfig);
      if (!account?.address) {
        showToast("Please connect wallet first", true);
        return;
      }

      const amountInput = document.getElementById('fromAmount').value;
      if (!amountInput || parseFloat(amountInput) <= 0) {
        showToast("Please enter valid amount", true);
        return;
      }

      isSwapping = true;
      const swapBtn = document.getElementById('approveOrSwap');
      const originalText = swapBtn.textContent;
      
      try {
        swapBtn.innerHTML = '<span class="spinner"></span>Processing...';
        swapBtn.disabled = true;

        const from = selectedFromToken.address;
        const to = selectedToToken.address;
        const isXPLPair = (from === 'XPL_NATIVE' && to === WXPL) || (from === WXPL && to === 'XPL_NATIVE');

        if (isXPLPair) {
          await executeWrapUnwrap();
        } else {
          await executeTokenSwap();
        }

        showToast("Transaction successful!");
        await updateBalances();
        computeOutput();

      } catch (error) {
        console.error('Swap error:', error);
        showToast(error.message || "Transaction failed", true);
      } finally {
        isSwapping = false;
        swapBtn.textContent = originalText;
        swapBtn.disabled = false;
      }
    }

    async function executeWrapUnwrap() {
      const account = getAccount(wagmiConfig);
      const amountInput = document.getElementById('fromAmount').value;
      const from = selectedFromToken.address;
      
      if (from === 'XPL_NATIVE') {
        // Wrap XPL -> WXPL
        const value = BigInt(Math.floor(parseFloat(amountInput) * 1e18));
        
        const { hash } = await writeContract(wagmiConfig, {
          address: WXPL,
          abi: ERC20_ABI,
          functionName: 'deposit',
          value: value
        });

        document.getElementById('txHash').innerHTML = `Tx: <a href="https://plasmascan.to/tx/${hash}" target="_blank">${hash.slice(0,10)}...${hash.slice(-8)}</a>`;
        await waitForTransaction(wagmiConfig, { hash });
        
      } else {
        // Unwrap WXPL -> XPL
        const value = BigInt(Math.floor(parseFloat(amountInput) * 1e18));
        
        const { hash } = await writeContract(wagmiConfig, {
          address: WXPL,
          abi: ERC20_ABI,
          functionName: 'withdraw',
          args: [value]
        });

        document.getElementById('txHash').innerHTML = `Tx: <a href="https://plasmascan.to/tx/${hash}" target="_blank">${hash.slice(0,10)}...${hash.slice(-8)}</a>`;
        await waitForTransaction(wagmiConfig, { hash });
      }
    }

    async function executeTokenSwap() {
      const account = getAccount(wagmiConfig);
      const amountInput = document.getElementById('fromAmount').value;
      const slippage = parseFloat(document.getElementById('slippage').value) || 0.5;
      const deadline = parseInt(document.getElementById('deadline').value) || 10;

      const from = selectedFromToken.address;
      const to = selectedToToken.address;
      const path = [
        from === 'XPL_NATIVE' ? WXPL : from,
        to === 'XPL_NATIVE' ? WXPL : to
      ];

      const fromDecimals = from === 'XPL_NATIVE' ? 18 : await readContract(wagmiConfig, {
        address: from,
        abi: ERC20_ABI,
        functionName: 'decimals'
      });

      const amountIn = BigInt(Math.floor(parseFloat(amountInput) * 10 ** fromDecimals));

      // Get expected output
      const amounts = await readContract(wagmiConfig, {
        address: ROUTER,
        abi: ROUTER_ABI,
        functionName: 'getAmountsOut',
        args: [amountIn, path]
      });

      const amountOutMin = amounts[1] * BigInt(10000 - Math.floor(slippage * 100)) / 10000n;
      const deadlineTime = Math.floor(Date.now() / 1000) + (deadline * 60);

      let hash;

      if (from === 'XPL_NATIVE') {
        // ETH -> Token
        const { hash: txHash } = await writeContract(wagmiConfig, {
          address: ROUTER,
          abi: ROUTER_ABI,
          functionName: 'swapExactETHForTokens',
          args: [amountOutMin, path, account.address, BigInt(deadlineTime)],
          value: amountIn
        });
        hash = txHash;
      } else if (to === 'XPL_NATIVE') {
        // Token -> ETH
        // Check allowance first
        const allowance = await readContract(wagmiConfig, {
          address: from,
          abi: ERC20_ABI,
          functionName: 'allowance',
          args: [account.address, ROUTER]
        });

        if (allowance < amountIn) {
          const { hash: approveHash } = await writeContract(wagmiConfig, {
            address: from,
            abi: ERC20_ABI,
            functionName: 'approve',
            args: [ROUTER, amountIn]
          });
          await waitForTransaction(wagmiConfig, { hash: approveHash });
        }

        const { hash: txHash } = await writeContract(wagmiConfig, {
          address: ROUTER,
          abi: ROUTER_ABI,
          functionName: 'swapExactTokensForETH',
          args: [amountIn, amountOutMin, path, account.address, BigInt(deadlineTime)]
        });
        hash = txHash;
      } else {
        // Token -> Token
        const allowance = await readContract(wagmiConfig, {
          address: from,
          abi: ERC20_ABI,
          functionName: 'allowance',
          args: [account.address, ROUTER]
        });

        if (allowance < amountIn) {
          const { hash: approveHash } = await writeContract(wagmiConfig, {
            address: from,
            abi: ERC20_ABI,
            functionName: 'approve',
            args: [ROUTER, amountIn]
          });
          await waitForTransaction(wagmiConfig, { hash: approveHash });
        }

        const { hash: txHash } = await writeContract(wagmiConfig, {
          address: ROUTER,
          abi: ROUTER_ABI,
          functionName: 'swapExactTokensForTokens',
          args: [amountIn, amountOutMin, path, account.address, BigInt(deadlineTime)]
        });
        hash = txHash;
      }

      document.getElementById('txHash').innerHTML = `Tx: <a href="https://plasmascan.to/tx/${hash}" target="_blank">${hash.slice(0,10)}...${hash.slice(-8)}</a>`;
      await waitForTransaction(wagmiConfig, { hash });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize tokens
      tokens = loadTokens();
      refreshSelectors();

      // Wallet connection
      document.getElementById('connectBtn').addEventListener('click', () => {
        modal.open();
      });

      // Swap button
      document.getElementById('approveOrSwap').addEventListener('click', executeSwap);

      // Max button
      document.getElementById('maxFrom').addEventListener('click', async () => {
        const account = getAccount(wagmiConfig);
        if (!account?.address) {
          showToast("Please connect wallet first", true);
          return;
        }

        if (selectedFromToken.address === 'XPL_NATIVE') {
          const balance = await getBalance(wagmiConfig, { address: account.address });
          document.getElementById('fromAmount').value = parseFloat(balance.formatted).toFixed(6);
        } else {
          const balance = await readContract(wagmiConfig, {
            address: selectedFromToken.address,
            abi: ERC20_ABI,
            functionName: 'balanceOf',
            args: [account.address]
          });
          const decimals = await readContract(wagmiConfig, {
            address: selectedFromToken.address,
            abi: ERC20_ABI,
            functionName: 'decimals'
          });
          document.getElementById('fromAmount').value = parseFloat(balance / 10n ** BigInt(decimals)).toFixed(6);
        }
        computeOutput();
      });

      // Flip tokens
      document.getElementById('flip').addEventListener('click', () => {
        if (!selectedFromToken || !selectedToToken) return;
        const temp = selectedFromToken;
        selectedFromToken = selectedToToken;
        selectedToToken = temp;
        selectToken('from', selectedFromToken);
        selectToken('to', selectedToToken);
      });

      // Add token
      document.getElementById('addTokenBtn').addEventListener('click', async () => {
        const address = prompt('Enter token contract address:');
        if (!address) return;

        try {
          // Validate address and get token info
          const symbol = await readContract(wagmiConfig, {
            address: address,
            abi: ERC20_ABI,
            functionName: 'symbol'
          });

          if (tokens.some(t => t.address.toLowerCase() === address.toLowerCase())) {
            showToast("Token already exists", true);
            return;
          }

          if (confirm(`Add ${symbol} token?`)) {
            tokens.push({
              symbol: symbol,
              address: address,
              logoURI: ''
            });
            saveTokens(tokens);
            refreshSelectors();
            showToast(`Token ${symbol} added successfully`);
          }
        } catch (error) {
          showToast("Invalid token address", true);
        }
      });

      // Input events
      document.getElementById('fromAmount').addEventListener('input', () => {
        setTimeout(computeOutput, 300);
      });

      // Watch for account changes
      watchAccount(wagmiConfig, {
        onChange: updateWalletUI
      });

      // Initial UI update
      updateWalletUI();
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.token-select-container')) {
        document.querySelectorAll('.token-dropdown').forEach(dd => {
          dd.style.display = 'none';
        });
      }
    });

    // Make functions globally available
    window.toggleDropdown = toggleDropdown;
    window.copyAddress = copyAddress;
  </script>
</body>
</html>